# NR ResQml

This Python package converts a Delft 3D output file on NetCDF4 format to a ResQml database

The package supports accessing Delft 3D files on the file system or via an OpenDAP server

Output generated by this package is an .epc file (zip archive) representing the data objects of the ResQml database and an .h5 file containing all relevant data. When running the module, the path to a valid and empty output directory must be provided (any missing directories will be created).

Launching the package from the command line can be done as follows:

<pre>
python -m nrresqml /path/to/delft3d.nc /path/to/output/directory
</pre>

The input path may also be a url to a .nc file on an OpenDAP server.

## 1. Converting local files to ResQml
The most straightforward option is to convert local files to ResQml. This will typically be files downloaded from https://delft3dgt.openearth.eu

Example:
<pre>
python -m nrresqml K:\Equinor\190549_Process_Models_Parameter_Estimation\06_Data\191002\transfer_244017_files_1b7b3625\trim-fine-sand.nc resqml-tfs
</pre>

## 2. Accessing GT server, unsupported method
The GT server can be accessed in an unsupported way as an OpenDAP server which does not require user name and password. It does, however, require knowing a url that includes a rather long identifier string (security by obscurity). This way of accessing the server has been in place for a long time at Deltares, but it is not officially supported. However, it is simpler than providing credentials to be read by the <tt>pydap</tt> package.

When a full URL to a NetCDF file on the GT server is known, "threads" may be replaced by "protected_threads".

Example:
<pre>
python -m nrresqml https://delft3dgt.openearth.eu/protected_thredds/dodsC/files/6ccd1dad-5782-4b2c-b97f-089271b65317/simulation/trim-coarse-sand.nc resqml-sediment
</pre>

## 3. Accessing GT server, supported method (work in progress)
Accessing the GT server the supported way is the same as above, however, it also requires a set of files correctly defined in the user's home directory.

On Linux, the following seems to be working:
* Create .netrc in home directory:
<pre>
machine delft3dgt.openearth.eu login __my-username__ password __my-password__
</pre>
* Create .dodsrc in home directory:
<pre>
HTTP.COOKIEJAR = /nr/sand/user/__my_local_username__/.cookies
HTTP.NETRC =  /nr/sand/user/__my_local_username__/.netrc
</pre>

To test that the files are setup correctly, the following command can be run (with <tt>curl</tt> installed):
<pre>
curl -v -n https://delft3dgt.openearth.eu/thredds/dodsC/files/6ccd1dad-5782-4b2c-b97f-089271b65317/simulation/trim-coarse-sand.nc
</pre>
The <tt>-n</tt> ensures that the .netrc files is used for credentials.

The expected output is currently a 500 internal server error. This is of course not a good error, but that is something we must discuss with Deltares IT, e.g. Maarten Pronk.

We may also be able to access the server using the built-in authentication options in <tt>pydap</tt>, instead of the netrc and dodsrc files. This probably requires us to setup a session first, then do a basic and digest access (see pydap docs: http://www.pydap.org/en/latest/)

On Windows, the .netrc file must be named _netrc, but there seems to be some other issues that causes the authentication to fail. We should ensure the program works as intended on Linux before digging into the Windows error, which requires the server to not return a 500 error.
